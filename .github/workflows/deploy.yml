name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: SSH Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            set -e
            echo "ðŸš€ Starting deployment..."
            cd /home/ubuntu/cslai
            echo "ðŸ”„ Fetching latest changes..."
            git fetch origin main
            git reset --hard origin/main
            pnpm install --no-frozen-lockfile
            pnpm --filter @company-intel/db exec prisma generate
            pnpm turbo run build
            # Load environment variables from .env file for migrations
            if [ -f .env ]; then export $(grep -v '^#' .env | xargs); fi
            pnpm --filter @company-intel/db exec prisma migrate deploy
            echo "ðŸ“¦ Copying Next.js static assets into standalone output..."
            cp -r apps/web/.next/static apps/web/.next/standalone/apps/web/.next/static
            if [ -d "apps/web/public" ]; then cp -r apps/web/public apps/web/.next/standalone/apps/web/public; fi
            echo "ðŸ”§ Updating Caddy configuration..."
            sudo cp infra/Caddyfile /etc/caddy/Caddyfile
            sudo systemctl reload caddy
            echo "ðŸ”„ Restarting application services..."
            pm2 restart all --update-env
            pm2 save
            echo "âœ… Deployment complete!"
